<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Farmacêutico</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" href=".././assets/icon/mini.svg" />
  </head>

  <body>
    <div id="menu-container"></div>
      <div class="header">
        <h1>Média da Evolução Anual da Demanda <span class="indicatorTitle estadoAtual">BRASIL</span></h1>
        <div class="calendar">
          <div class="timeIndicator">
              <span class="startEnd">De</span>
              <span class="date"  id="start-date">2021</span>
          </div>
          <img src="../assets/icon/longArrow.svg" class="arrow" />
          <div class="timeIndicator">
              <span class="startEnd">Até</span>
              <span class="date"  id="end-date">2022</span>
          </div>
          
          <img src="../assets/icon/calender.svg" class="iconCalendar" onclick="openCalendar()" id="open-modal-btn"/>

      </div>
  </div>
        <!-- Modal -->
        <div id="modal" class="modal">
          <div class="modal-content">
            <span id="close-modal" class="close-btn">&times;</span>
            <h2>Filtrar Dados</h2>
            <div class="modal-input">
              <label for="modalAnoInicial">Ano Inicial:</label>
              <select id="modalAnoInicial">
                <option value="2021">2021</option>
                <option value="2022">2022</option>
                <option value="2023">2023</option>
              </select>
            </div>
            <div class="modal-input">
              <label for="modalAnoFinal">Ano Final:</label>
              <select id="modalAnoFinal">
                <option value="2021">2021</option>
                <option value="2022">2022</option>
                <option value="2023">2023</option>
              </select>
            </div>
            <div class="modal-input">
              <label for="modalEstado">Estado:</label>
              <select id="modalEstado">
                <option value="SP">São Paulo</option>
                <option value="PB">Pernambuco</option>
                <option value="AL">Alagóas</option>
                <option value="DF">Distrito Federal</option>
                <option value="GO">Goiás</option>
              </select>
            </div>
            <button id="search-btn">Pesquisar</button>
          </div>
        </div>
      </div>
      <div class="header-container">
        <div class="kpi" id="kpi-soro">
          <h4>Soro</h4>
          <p>0 sachês</p>
          <span class="indicator up" data-valor-atual="0">0%</span>
      </div>
      <div class="kpi" id="kpi-repelente">
          <h4>Repelentes</h4>
          <p>0 repelentes</p>
          <span class="indicator up" data-valor-atual="0">0%</span>
      </div>
        <div class="kpi">
          <h4>Paracetamol</h4>
          <p>0 milhões casos</p>
          <span class="indicator up">0%</span>
        </div>
        <div class="kpi">
          <h4>Testes</h4>
          <p>0 milhões casos</p>
          <span class="indicator up">0%</span>
        </div>
      </div>
      <div class="charts-container">
        <div class="chart-group">
          <!-- Grupo de gráficos à esquerda -->
          <div class="lineChart">
            <div class="chartHeader">
              <p>Projeção de Consumo de Repelentes Por Ano</p>
            </div>
            <div class="chart">
              <canvas id="state1"></canvas>
            </div>
          </div>                  
          <div class="lineChart">
            <div class="chartHeader">
              <p>Projeção de Consumo de Soro Por Ano</p>
              <!-- <span class="indicatorTitle estadoAtual">BRASIL</span> -->
            </div>
            <div class="chart">
              <canvas id="state2"></canvas>
            </div>
          </div>
        </div>
        <div class="chart-group">
          <!-- Grupo de gráficos à direita -->
          <div class="lineChart">
            <div class="chartHeader">
              <p>Demanda de Testes Diagnósticos Anuais</p>
              <!-- <span class="indicatorTitle estadoAtual">BRASIL</span> -->
            </div>
            <div class="chart">
              <canvas id="state3"></canvas>
            </div>
          </div>
          <div class="lineChart">
            <div class="chartHeader">
              <p>Previsão de Demanda de Paracetamol Anual</p>
              <!-- <span class="indicatorTitle estadoAtual">BRASIL</span> -->
            </div>
            <div class="chart">
              <canvas id="state4"></canvas>
            </div>
          </div>
        </div>
    </div>
  </body>
</html>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="../js/menubehavior.js"></script>
<script src="../js/menu.js"></script>
<script src="./main.js"></script>

<script>

function animarPercentual(element, valorFinal, duracao = 1000) {
    const valorInicial = parseFloat(element.getAttribute("data-valor-atual")) || 0;

    element.setAttribute("data-valor-atual", valorFinal.toFixed(2));

    const incremento = (valorFinal - valorInicial) / (duracao / 16); 
    let valorAtual = valorInicial;

    function atualizar() {
        valorAtual += incremento;

        if ((incremento > 0 && valorAtual >= valorFinal) || (incremento < 0 && valorAtual <= valorFinal)) {
            element.textContent = `${valorFinal.toFixed(2)}%`;
        } else {
            element.textContent = `${valorAtual.toFixed(2)}%`;
            requestAnimationFrame(atualizar);
        }
    }

    requestAnimationFrame(atualizar);
}


  function buscarEstadoEmpresa() {
    const idEmpresa = sessionStorage.ID_EMPRESA;

    if (!idEmpresa || isNaN(idEmpresa)) {
      console.error("ID da empresa não definido ou inválido.");
      alert(
        "Erro: ID da empresa não encontrado. Por favor, faça login novamente."
      );
      return;
    }

    console.log("ID da empresa:", idEmpresa);

    fetch(`/usuarios/${idEmpresa}`)
      .then(function (resposta) {
        console.log("Resposta da API:", resposta);

        if (resposta.ok) {
          resposta.json().then(function (dadosEmpresa) {
            console.log("Dados da empresa:", dadosEmpresa);

            const estado = dadosEmpresa[0].estado;

            if (estado) {
              atualizarProjecaoRepelentes(estado);
              atualizarProjecaoTestes(estado);
            } else {
              console.error("Estado não encontrado nos dados da empresa.");
            }
          });
        } else {
          throw "Erro ao buscar os dados da empresa.";
        }
      })
      .catch(function (erro) {
        console.log("#ERRO:", erro);
      });
  }

  function atualizarProjecaoRepelentes(estadoVar) {
  console.log("Estado selecionado: ", estadoVar);

  fetch(`/usuarios/casos`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      estadoServer: estadoVar,
    }),
  })
    .then(function (resposta) {
      if (resposta.ok) {
        resposta.json().then(function (dados) {
          var anos = [];
          var casos = [];
          dados.forEach(function (dado) {
            anos.push(dado.ano);
            casos.push(dado.quantidade);
          });

          const regressao = calcularRegressaoLinear(anos, casos);

          const casos2024 = calcularProjecao(2024, regressao);
          anos.push(2024);
          casos.push(casos2024);

          const casos2025 = calcularProjecao(2025, regressao);
          anos.push(2025);
          casos.push(casos2025);

          const chart = Chart.getChart("state1");
          if (chart) {
            chart.data.labels = anos;
            chart.data.datasets[0].data = casos;
            chart.update();
            console.log("Gráfico de repelentes atualizado com sucesso!");
          } else {
            console.error("Gráfico de repelentes não encontrado!");
          }
        });
      } else {
        console.log("Erro ao buscar dados de casos para o estado selecionado.");
      }
    })
    .catch(function (erro) {
      console.log("Erro na requisição de repelentes:", erro);
    });
}

function calcularRegressaoLinear(anos, valores) {
  const n = anos.length;
  const mediaX = anos.reduce((soma, x) => soma + x, 0) / n;
  const mediaY = valores.reduce((soma, y) => soma + y, 0) / n;

  let numerador = 0;
  let denominador = 0;

  for (let i = 0; i < n; i++) {
    numerador += (anos[i] - mediaX) * (valores[i] - mediaY);
    denominador += Math.pow(anos[i] - mediaX, 2);
  }

  const m = numerador / denominador;
  const b = mediaY - m * mediaX;

  return { m, b };
}

function calcularProjecao(ano, regressao) {
  const projRegressao = Math.round(regressao.m * ano + regressao.b);
  return projRegressao;
}


function atualizarProjecaoTestes(estadoVar) {
  console.log("Estado selecionado: ", estadoVar);

  fetch(`/usuarios/testes`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      estadoServer: estadoVar,
    }),
  })
    .then(function (resposta) {
      if (resposta.ok) {
        resposta.json().then(function (dados) {
          var anos = [];
          var vendas = [];

          dados.forEach(function (dado) {
            anos.push(dado.ano);
            vendas.push(dado.quantidade);
          });

          console.log("Anos reais recebidos: ", anos);
          console.log("Vendas reais: ", vendas);

          const regressao = calcularRegressaoLinear(anos, vendas);

          const anosProjetados = [2024, 2025];
          const vendasProjetadas = anosProjetados.map((ano) =>
          calcularProjecao(ano, regressao)
                  );

          console.log("Anos projetados: ", anosProjetados);
          console.log("Vendas projetadas: ", vendasProjetadas);

          const todosAnos = [...anos, ...anosProjetados];
          const todasVendas = [...vendas, ...vendasProjetadas];

          const chart = Chart.getChart("state3");
          if (chart) {
            chart.data.labels = todosAnos;

            chart.data.datasets = [
              {
                label: "Quantidade de testes vendidos (Dados reais)",
                data: todasVendas,
                borderColor: "rgb(0, 82, 204)",
                backgroundColor: "rgba(0, 82, 204, 0.1)",
                fill: false,
                tension: 0.4,
                borderWidth: 2,
                segment: {
                  borderDash: (ctx) => {
                    const index = ctx.p0DataIndex;
                    return index < vendas.length - 1 ? [] : [5, 5]; 
                  },
                },
              },
              {
                label: "Previsão",
                data: [], 
                borderColor: "rgb(0, 82, 204)",
                borderWidth: 2,
                borderDash: [5, 5], 
              },
            ];

            chart.update();
            console.log("Gráfico atualizado com sucesso!");
          } else {
            console.error("Gráfico não encontrado!");
          }
        });
      } else {
        console.error("Erro ao buscar dados para o estado.");
      }
    })
    .catch(function (erro) {
      console.error("Erro na requisição de testes:", erro);
    });
}

  function atualizarKPI(estadoVar) {
    const estadoElement = document.getElementById("modalEstado");
    const anoInicialElement = document.getElementById("modalAnoInicial");
    const anoFinalElement = document.getElementById("modalAnoFinal");

    if (!estadoElement || !anoInicialElement || !anoFinalElement) {
        console.error("Um ou mais elementos do modal não foram encontrados!");
        return;
    }

    const estado = estadoElement.value;
    const anoInicial = anoInicialElement.value || "2022"; 
    const anoFinal = anoFinalElement.value || "2023"; 

    console.log("Dados a serem enviados:", {
        estadoServer: estado,
        anoInicialServer: anoInicial,
        anoFinalServer: anoFinal,
    });

    fetch(`/usuarios/demanda`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
            estadoServer: estado,
            anoInicialServer: anoInicial,
            anoFinalServer: anoFinal,
        }),
    })
        .then((resposta) => {
            if (resposta.ok) {
                return resposta.json();
            } else {
                console.error("Erro ao buscar dados da demanda.");
                return null;
            }
        })
        .then((dados) => {
            if (dados) {
                console.log("Dados recebidos:", dados);

                const mediaDemandaRepelente = calcularMediaDemandaRepelente(dados);
                const percentualEvolucaoRepelente = calcularPercentualEvolucaoRepelente(dados);

                const mediaDemandaSoro = calcularMediaDemanda(dados);
                const percentualEvolucaoSoro = calcularPercentualEvolucao(dados);

                atualizarKPIRepelente(mediaDemandaRepelente, percentualEvolucaoRepelente);
                atualizarKPICard(mediaDemandaSoro, percentualEvolucaoSoro);
            }
        })
        .catch((erro) => console.error("Erro na requisição:", erro));
}

  function calcularMediaDemanda(dados) {
    const totalCasos = dados.reduce((acc, curr) => acc + curr.quantidade, 0);
    const totalSoro = totalCasos * 5;
    return totalSoro / dados.length;
  }

  function calcularPercentualEvolucao(dados) {
    if (dados.length < 2) return 0;

    const primeiroAnoCasos = dados[0].quantidade;
    const ultimoAnoCasos = dados[dados.length - 1].quantidade;

    const percentualEvolucao = ((ultimoAnoCasos - primeiroAnoCasos) / primeiroAnoCasos) * 100;

    return percentualEvolucao * 0.8;  
  }

  function atualizarKPICard(mediaDemanda, percentualEvolucao) {
    const kpiCard = document.getElementById("kpi-soro");
    if (!kpiCard) {
        console.error("Elemento do KPI de soro não encontrado!");
        return;
    }

    kpiCard.querySelector("p").textContent = `${mediaDemanda.toFixed(2)} sachês de soro`;

    const indicador = kpiCard.querySelector(".indicator");
    animarPercentual(indicador, percentualEvolucao);

    indicador.classList.toggle("up", percentualEvolucao >= 0);
    indicador.classList.toggle("down", percentualEvolucao < 0);

    if (percentualEvolucao < 0) {
        indicador.style.color = "green";
    } else {
        indicador.style.color = "";
    }
}

function atualizarKPIRepelente(mediaDemanda, percentualEvolucao) {
    const kpiCard = document.getElementById("kpi-repelente");
    if (!kpiCard) {
        console.error("Elemento do KPI de repelentes não encontrado!");
        return;
    }

    kpiCard.querySelector("p").textContent = `${mediaDemanda.toFixed(2)} repelentes`;

    const indicador = kpiCard.querySelector(".indicator");
    animarPercentual(indicador, percentualEvolucao);

    indicador.classList.toggle("up", percentualEvolucao >= 0);
    indicador.classList.toggle("down", percentualEvolucao < 0);

    if (percentualEvolucao < 0) {
        indicador.style.color = "green";
    } else {
        indicador.style.color = "";
    }
}

function calcularMediaDemandaRepelente(dados) {
    const total = dados.reduce((acc, curr) => acc + curr.quantidade, 0);
    const mediaRepelentes = total * 2;  
    return mediaRepelentes / dados.length;
}

function calcularPercentualEvolucaoRepelente(dados) {
    if (dados.length < 2) return 0;

    const primeiroAno = dados[0].quantidade;
    const ultimoAno = dados[dados.length - 1].quantidade;

    const percentualEvolucao = ((ultimoAno - primeiroAno) / primeiroAno) * 100;

    return percentualEvolucao * 1.2;  
}

  function atualizarEstadoVisualizado() {
    const estadoSelecionado = document.getElementById('modalEstado').value;
    const estados = document.querySelectorAll('.estadoAtual'); 
    
    estados.forEach(function(estadoTexto) {
        switch(estadoSelecionado) {
            case 'SP':
                estadoTexto.textContent = "(São Paulo)";
                break;
            case 'PB':
                estadoTexto.textContent = "(Pernambuco)";
                break;
            case 'AL':
                estadoTexto.textContent = "(Alagoas)";
                break;
            case 'DF':
                estadoTexto.textContent = "(Distrito Federal)";
                break;
            case 'GO':
                estadoTexto.textContent = "(Goiás)";
                break;
            default:
                estadoTexto.textContent = "BRASIL";
        }
    });
}

document.getElementById('modalEstado').addEventListener('change', atualizarEstadoVisualizado);


atualizarEstadoVisualizado(); 
  buscarEstadoEmpresa();
  atualizarKPI();
  atualizarKPICard(150.35, 12.78);
setTimeout(() => atualizarKPICard(160.50, 20.45), 2000);

atualizarKPIRepelente(75.50, -8.45);
setTimeout(() => atualizarKPIRepelente(80.00, -3.25), 2000);

</script>
