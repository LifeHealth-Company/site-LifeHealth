<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Farmacêutico</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" href=".././assets/icon/mini.svg" />
  </head>
  
  <body>
    <div id="menu-container"></div>
    <div class="home">
      <div class="header">
        <h1>Média da Evolução Anual da Demanda</h1>
        <div>
          <label for="anoInicial">Ano Inicial:</label>
          <select id="anoInicial" onchange="atualizarKPI()">
            <option value="2021">2021</option>
            <option value="2022">2022</option>
            <option value="2023">2023</option>
          </select>
        </div>
        
        <div>
          <label for="anoFinal">Ano Final:</label>
          <select id="anoFinal" onchange="atualizarKPI()">
            <option value="2021">2021</option>
            <option value="2022">2022</option>
            <option value="2023">2023</option>
          </select>
        </div>
        <select id="selectEstados" onchange="atualizarProjecaoRepelentes(); atualizarProjecaoTestes()">
          <option value="SP">São Paulo</option>
          <option value="PB">Pernambuco</option>
          <option value="AL">Alagóas</option>
          <option value="DF">Distrito Federal</option>
          <option value="GO">Góias</option>
        </select>
      </div>
      <div class="header-container">
        <div class="kpi">
          <h4>Soro</h4>
          <p>2 milhões casos</p>
          <span class="indicator up">20%</span>
        </div>
        <div class="kpi">
          <h4>Repelentes</h4>
          <p>2 milhões casos</p>
          <span class="indicator up">20%</span>
        </div>
        <div class="kpi">
          <h4>Paracetamol</h4>
          <p>2 milhões casos</p>
          <span class="indicator up">20%</span>
        </div>
        <div class="kpi">
          <h4>Testes</h4>
          <p>2 milhões casos</p>
          <span class="indicator up">20%</span>
        </div>
      </div>
      <div class="charts-container">
        <div class="chart-group">
          <!-- Grupo de gráficos à esquerda -->
          <div class="lineChart">
            <h2>Projeção de Consumo de Repelentes</h2>
            <div class="chart">
              <canvas id="state1"></canvas>
            </div>
          </div>
          <div class="lineChart">
            <h2>Projeção de Consumo de Soro por ano</h2>
            <div class="chart">
              <canvas id="state2"></canvas>
            </div>
          </div>
        </div>
        <div class="chart-group">
          <!-- Grupo de gráficos à direita -->
          <div class="lineChart">
            <h2>Demanda de Testes Diagnósticos Anuais</h2>
            <div class="chart">
              <canvas id="state3"></canvas>
            </div>
          </div>
          <div class="lineChart">
            <h2>Previsão de Demanda de Paracetamol Anual</h2>
            <div class="chart">
              <canvas id="state4"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="../js/menubehavior.js"></script>
<script src="../js/menu.js"></script>
<script src="./main.js"></script>

<script>
function atualizarProjecaoRepelentes() {

  var estadoVar = document.getElementById("selectEstados").value;

    console.log("Estado selecionado: ", estadoVar);

    fetch(`/usuarios/casos`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            estadoServer: estadoVar
        })
    }).then(function (resposta) {
        console.log("ESTOU NO THEN DO atualizarProjecaoRepelentes()!");

        if (resposta.ok) {
            resposta.json().then(function (dados) {
                console.log("Dados recebidos:", dados);

                var anos = [];
                var casos = [];

                dados.forEach(function (dado) {
                    anos.push(dado.ano);
                    casos.push(dado.quantidade);
                });

                var CAGR = calcularCAGR(casos); 
                var casos2024 = Math.round(casos[casos.length - 1] * (1 + CAGR));
                anos.push("2024");
                casos.push(casos2024);

                const chart = Chart.getChart("state1");
                if (chart) {
                    chart.data.labels = anos;
                    chart.data.datasets[0].data = casos;

                    chart.data.datasets[0].backgroundColor = anos.map((ano, index) =>
                        index % 2 === 0 ? "#AA00FF" : "#193D65"
                    );

                    chart.update();
                    console.log("Gráfico atualizado com sucesso!");
                } else {
                    console.error("Gráfico não encontrado!");
                }
            });
        } else {
            console.log("Erro ao buscar dados de casos para o estado selecionado.");
            resposta.text().then(function (texto) {
                console.error(texto);
            });
        }
    }).catch(function (erro) {
        console.log("Erro na requisição:", erro);
    });

    return false;
}

function calcularCAGR(casos) {
    if (casos.length < 2) return 0;

    var V_inicial = casos[0];
    var V_final = casos[casos.length - 1];
    var n = casos.length - 1;

    return Math.pow(V_final / V_inicial, 1 / n) - 1;
}

function atualizarProjecaoTestes() {
    var estadoVar = document.getElementById("selectEstados").value;

    console.log("Estado selecionado: ", estadoVar);

    fetch(`/usuarios/testes`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
            estadoServer: estadoVar,
        }),
    })
        .then(function (resposta) {
            console.log("ESTOU NO THEN DO atualizarProjecaoTestes()!");

            if (resposta.ok) {
                resposta.json().then(function (dados) {
                    console.log("Dados recebidos:", dados);

                    var anos = [];
                    var vendasReais = [];
                    var vendasProjetadas = [];

                    dados.forEach(function (dado) {
                        anos.push(dado.ano);
                        vendasReais.push(dado.quantidade);
                    });

                    var populacaoInicial = 1000000;
                    var crescimentoPopulacional = 0.02;

                    for (let i = 0; i < anos.length; i++) {
                        let populacaoAno = Math.round(
                            populacaoInicial * Math.pow(1 + crescimentoPopulacional, i)
                        );
                        vendasProjetadas.push((vendasReais[i] / populacaoAno) * populacaoInicial);
                    }

                    var CAGR = calcularCAGR(vendasReais);
                    var vendas2024 = Math.round(vendasReais[vendasReais.length - 1] * (1 + CAGR));
                    var vendas2025 = Math.round(vendas2024 * (1 + CAGR));

                    anos.push("2024", "2025");
                    vendasProjetadas.push(vendas2024, vendas2025);

                    const chart = Chart.getChart("state3");
                    if (chart) {
                        chart.data.labels = anos;
                        chart.data.datasets[0].data = vendasReais;
                        chart.data.datasets[1].data = vendasProjetadas;

                        chart.update();
                        console.log("Gráfico atualizado com sucesso!");
                    } else {
                        console.error("Gráfico não encontrado!");
                    }
                });
            } else {
                console.log("Erro ao buscar dados de testes para o estado selecionado.");
                resposta.text().then(function (texto) {
                    console.error(texto);
                });
            }
        })
        .catch(function (erro) {
            console.log("Erro na requisição:", erro);
        });

    return false;
}

function atualizarKPI() {
    const estado = document.getElementById("selectEstados").value;
    const anoInicial = document.getElementById("anoInicial").value;
    const anoFinal = document.getElementById("anoFinal").value;

    fetch(`/usuarios/demanda`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            estadoServer: estado,
            anoInicialServer: anoInicial,
            anoFinalServer: anoFinal
        })
    }).then(resposta => {
        if (resposta.ok) {
            return resposta.json();
        } else {
            console.error("Erro ao buscar dados da demanda.");
        }
    }).then(dados => {
        if (dados) {
            console.log("Dados recebidos:", dados);

            const mediaDemanda = calcularMediaDemanda(dados);
            const percentualEvolucao = calcularPercentualEvolucao(dados);

            atualizarKPICard(mediaDemanda, percentualEvolucao);
        }
    }).catch(erro => console.error("Erro na requisição:", erro));
}


function calcularPercentualEvolucao(dados) {
    if (dados.length < 2) return 0;

    const primeiroAno = dados[0].quantidade;
    const ultimoAno = dados[dados.length - 1].quantidade;

    return ((ultimoAno - primeiroAno) / primeiroAno) * 100;
}

function atualizarKPICard(mediaDemanda, percentualEvolucao) {
    const kpiCard = document.querySelector(".kpi");
    kpiCard.querySelector("p").textContent = `${mediaDemanda.toFixed(2)} milhões de casos`;
    const indicador = kpiCard.querySelector(".indicator");
    indicador.textContent = `${percentualEvolucao.toFixed(2)}%`;
    indicador.classList.toggle("up", percentualEvolucao >= 0);
    indicador.classList.toggle("down", percentualEvolucao < 0);
}


</script>